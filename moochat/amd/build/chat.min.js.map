{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["/* This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// any later version.\n/**\n * Privacy Subsystem implementation for mod_mooproof\n *\n * @package    block_moochat\n * @copyright  2025 Brian A. Pool\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n\n    return {\n        init: function(instanceid, strings) {\n\n            var conversationHistory = [];\n            // Var messageCount = 0;\n            var remainingQuestions = -1; // -1 means unlimited\n\n            var messagesDiv = $('#moochat-messages-' + instanceid);\n            var inputField = $('#moochat-input-' + instanceid);\n            var sendButton = $('#moochat-send-' + instanceid);\n            var clearButton = $('#moochat-clear-' + instanceid);\n\n            // Create remaining questions display\n            var remainingDiv = $('<div class=\"moochat-remaining\" id=\"moochat-remaining-' + instanceid + '\"></div>');\n            $('#moochat-' + instanceid).prepend(remainingDiv);\n\n    // Update remaining questions display\n    var updateRemaining = function(remaining) {\n        if (remaining >= 0) {\n        var message = strings.questionsremaining.replace('{$a}', remaining);\n        remainingDiv.html('<p class=\"alert alert-info\">' + message + '</p>');\n        remainingDiv.show();\n        } else {\n        remainingDiv.hide();\n        }\n    };\n\n            // Send message\n            var sendMessage = function() {\n                var message = inputField.val().trim();\n\n                if (message === '') {\n                    return;\n                }\n\n                // Disable input while processing\n                inputField.prop('disabled', true);\n                sendButton.prop('disabled', true);\n\n                // Add user message to display\n                addMessage('user', message);\n\n                // Add to history\n                conversationHistory.push({\n                    role: 'user',\n                    content: message\n                });\n\n                // Clear input\n                inputField.val('');\n\n                // Show thinking indicator\n                var thinkingId = 'thinking-' + Date.now();\n                messagesDiv.append(\n                    '<div class=\"moochat-message moochat-assistant\" id=\"' + thinkingId + '\">' +\n                    '<em>' + strings.thinking + '</em></div>'\n                );\n                scrollToBottom();\n\n                // Call API using Moodle's External Service\n                Ajax.call([{\n                    methodname: 'block_moochat_send_message',\n                    args: {\n                        instanceid: instanceid,\n                        message: message,\n                        history: JSON.stringify(conversationHistory)\n                    },\n                    done: function(response) {\n                        // Remove thinking indicator\n                        $('#' + thinkingId).remove();\n\n                        if (!response.success) {\n                            // Check if this is a rate limit error\n                            if (response.remaining !== undefined && response.remaining === 0) {\n                                Notification.alert(strings.ratelimitreached_title, response.error, 'OK');\n                                inputField.prop('disabled', true);\n                                sendButton.prop('disabled', true);\n                                updateRemaining(0);\n                            } else if (response.error === strings.maxmessagesreached) {\n                                Notification.alert(strings.chatlimitreached, response.error, 'OK');\n                            } else {\n                                Notification.alert(strings.error, response.error, 'OK');\n                            }\n                        } else if (response.success && response.reply) {\n                            // Add assistant reply\n                            addMessage('assistant', response.reply);\n\n                            // Add to history\n                            conversationHistory.push({\n                                role: 'assistant',\n                                content: response.reply\n                            });\n\n                            // MessageCount++;\n\n                            // Update remaining questions\n                            if (response.remaining !== undefined) {\n                                remainingQuestions = response.remaining;\n                                updateRemaining(remainingQuestions);\n\n                                // Disable if no questions left\n                                if (remainingQuestions === 0) {\n                                    inputField.prop('disabled', true);\n                                    sendButton.prop('disabled', true);\n                                }\n                            }\n                        }\n\n                        // Re-enable input (unless disabled by rate limit)\n                        if (remainingQuestions !== 0) {\n                            inputField.prop('disabled', false);\n                            sendButton.prop('disabled', false);\n                            inputField.focus();\n                        }\n                    },\n                    fail: function() {\n                        $('#' + thinkingId).remove();\n                        Notification.alert(strings.error, strings.connectionerror, 'OK');\n                        inputField.prop('disabled', false);\n                        sendButton.prop('disabled', false);\n                    }\n                }]);\n            };\n\n            // Add message to display\n            var addMessage = function(role, content) {\n                var messageClass = role === 'user' ? 'moochat-user' : 'moochat-assistant';\n                var messageHtml = '<div class=\"moochat-message ' + messageClass + '\">' +\n                                 escapeHtml(content) + '</div>';\n                messagesDiv.append(messageHtml);\n                scrollToBottom();\n            };\n\n            // Scroll to bottom of messages\n            var scrollToBottom = function() {\n                messagesDiv.scrollTop(messagesDiv[0].scrollHeight);\n            };\n\n            // Escape HTML\n            var escapeHtml = function(text) {\n                var div = document.createElement('div');\n                div.textContent = text;\n                return div.innerHTML;\n            };\n\n            // Clear chat (visual only - doesn't reset server counter)\n            var clearChat = function() {\n                conversationHistory = [];\n                // MessageCount = 0;\n                messagesDiv.html('<p class=\"moochat-welcome\">' + strings.chatcleared + '</p>');\n                inputField.val('').focus();\n                // Note: remaining questions counter stays the same\n            };\n\n            // Event handlers\n            sendButton.on('click', sendMessage);\n\n            inputField.on('keypress', function(e) {\n                if (e.which === 13 && !e.shiftKey) {\n                    e.preventDefault();\n                    sendMessage();\n                }\n            });\n\n            clearButton.on('click', function() {\n                if (confirm(strings.confirmclear)) {\n                    clearChat();\n                }\n            });\n\n            // Focus input on load\n            inputField.focus();\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","init","instanceid","strings","conversationHistory","remainingQuestions","messagesDiv","inputField","sendButton","clearButton","remainingDiv","prepend","updateRemaining","remaining","message","questionsremaining","replace","html","show","hide","sendMessage","val","trim","prop","addMessage","push","role","content","thinkingId","Date","now","append","thinking","scrollToBottom","call","methodname","args","history","JSON","stringify","done","response","remove","success","reply","undefined","alert","ratelimitreached_title","error","maxmessagesreached","chatlimitreached","focus","fail","connectionerror","messageHtml","escapeHtml","scrollTop","scrollHeight","text","div","document","createElement","textContent","innerHTML","on","e","which","shiftKey","preventDefault","confirm","confirmclear","chatcleared"],"mappings":"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"}